<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]>      <html class="no-js"> <!--<![endif]-->
<html>
    <head>
        <title>A Leaflet map!</title>
        <link rel="stylesheet" href="https://d19vzq90twjlae.cloudfront.net/leaflet-0.7.3/leaflet.css" />
        <script src="https://d19vzq90twjlae.cloudfront.net/leaflet-0.7.3/leaflet.js"></script>
        <style>
          #map{ position:absolute;top:0;left:0;bottom:0;right:0; }
          .wikidata {
      white-space: nowrap;
      width: auto;
      height: auto;
      background: orange;
      border: 1px solid black;
    }

    .wikidata.q {
      background: black;
      color: orange;
    }
        </style>
      </head>
    <body>
        <div id="map"></div>

        <script>
      
        // initialize the map
        var map = L.map('map').setView([52.2110,-3.8123], 12)
      
        // load a tile layer
        L.tileLayer('http://openstreetmap.cymru/osm_tiles/{z}/{x}/{y}.png',
          {
            attribution: 'Tiles by <a href="http://mapc.org">MAPC</a>, Data by <a href="http://mass.gov/mgis">MassGIS</a>',
            maxZoom: 17,
            minZoom: 9
          }).addTo(map);

var group = L.layerGroup().addTo(map);
    var lang = "cy";
    if (location.search.match(/^\?([a-zA-Z_]+)$/)) lang = RegExp.$1;

    map.on("moveend", function() {
      var bounds = map.getBounds();
      var sparql =
      `SELECT ?place ?placeLabel ?location WHERE {
SERVICE wikibase:box {
 ?place wdt:P625 ?location.
 bd:serviceParam wikibase:cornerWest "Point(${bounds.getWest()} ${bounds.getNorth()})"^^geo:wktLiteral.
 bd:serviceParam wikibase:cornerEast "Point(${bounds.getEast()} ${bounds.getSouth()})"^^geo:wktLiteral.
}
SERVICE wikibase:label { bd:serviceParam wikibase:language "${lang}". }
} limit 2000`;
      group.clearLayers();
      fetch("https://query.wikidata.org/sparql?query=" + encodeURIComponent(sparql), {
        "headers": {
          "accept": "application/sparql-results+json"
        },
        "method": "GET",
        "mode": "cors"
      }).then(a => a.json()).then(a => {
        a.results.bindings.forEach(x => {
          if (x.location.value.match(/^Point\((.+) (.+)\)$/)) {
            var lon = parseFloat(RegExp.$1);
            var lat = parseFloat(RegExp.$2);
            var html = "<span class='wikidata'>" + x.placeLabel.value + "</span>";
            if (x.placeLabel.value.match(/^Q[0-9]+$/)) html = html.replace("wikidata", "wikidata q");
            L.marker([lat, lon], {
              icon: L.divIcon({
                html: html
              })
            }).addTo(group);
          }
        });
      });
    }).fire("moveend");

 
        </script>
    </body>
</html>