<!DOCTYPE html>
<html>
<head>
<title>Wikidata Overlays</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
   integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
   crossorigin=""/>
   <link rel="stylesheet" href="local_styles.css"/>
   <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
   integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
   crossorigin=""></script>
</head>
<body>


<div id="map"></div>

<script>

// initialize the map
var map = L.map('map').setView([52.2110,-3.8123], 12)

// load a tile layer

var basemap_0 = L.tileLayer('http://openstreetmap.cymru/osm_tiles/{z}/{x}/{y}.png',
  {
    attribution: 'Tiles by <a href="https://mapio.cymru">Mapio Cymru</a>, Data by <a href="https://wikidata.org">Wikidata</a>',
    maxZoom: 17,
    minZoom: 9
  })
  basemap_0.addTo(map);
  
  // prepare a marker icon
  var myIcon = L.icon({
    iconUrl: 'marker.png',
    iconSize: [95, 95],
    iconAnchor: [22, 94],
    popupAnchor: [-3, -76],
});

var lang = "cy"

var schools = L.layerGroup()
    
    
    if (location.search.match(/^\?([a-zA-Z_]+)$/)) lang = RegExp.$1;

    map.on("moveend", function() {
      var bounds = map.getBounds();
      var sparql_1 =
      'SELECT ?place ?placeLabel ?location WHERE {
SERVICE wikibase:box {
 ?place wdt:P625 ?location.
 bd:serviceParam wikibase:cornerWest "Point(${bounds.getWest()} ${bounds.getNorth()})"^^geo:wktLiteral.
 bd:serviceParam wikibase:cornerEast "Point(${bounds.getEast()} ${bounds.getSouth()})"^^geo:wktLiteral.
}
FILTER EXISTS { ?place wdt:P31/wdt:P279* wd:Q2385804 }
  ?place wdt:P31 ?type .
minus { ?place wdt:P576 ?end } .            
minus { ?place wdt:P31 wd:Q1244442 } .
SERVICE wikibase:label { bd:serviceParam wikibase:language "cy". }
} limit 2000';
      schools.clearLayers();
      fetch("https://query.wikidata.org/sparql?query=" + encodeURIComponent(sparql_1), {
        "headers": {
          "accept": "application/sparql-results+json"
        },
        "method": "GET",
        "mode": "cors"
      }).then(a => a.json()).then(a => {
        a.results.bindings.forEach(x => {
          if (x.location.value.match(/^Point\((.+) (.+)\)$/)) {
            var lon = parseFloat(RegExp.$1);
            var lat = parseFloat(RegExp.$2);
            var html = "<span class='wikidata'> <a href=\"https://www.openstreetmap.org/edit#map=16/" + lat + "/" + lon + "\">" + x.placeLabel.value + "</a></span>";
            if (x.placeLabel.value.match(/^Q[0-9]+$/)) html = html.replace("wikidata", "wikidata q");
            L.marker([lat, lon],{icon: myIcon}).bindPopup(html).openPopup().addTo(schools);
          }
        });
      });
    }).fire("moveend");

var baseLayers = {
    "OpenStreetMap": basemap_0
};

var overlays = {
   "Ysgol": schools


};
L.control.layers(baseLayers, overlays, {collapsed:false}).addTo(map);

</script>
</body>
</html>